(()=>{var t={36:(t,e,a)=>{const s=a(252).Router();s.get("/",((t,e)=>{e.json([{id:1,name:"用户1"},{id:2,name:"用户2"}])})),t.exports=s},136:(t,e,a)=>{const s=a(498);a(818).config();const i=s.createPool({host:"mysql.sqlpub.com",port:parseInt("3306"),user:"duwuzhou",password:"6ai23FuAgXbKUaTt",database:"kongtianjun",waitForConnections:!0,connectionLimit:parseInt("10"),queueLimit:parseInt("0")});t.exports=i},252:t=>{"use strict";t.exports=require("express")},325:(t,e,a)=>{const s=a(252).Router(),i=a(346),n=a(577);s.use(n({origin:["https://duwuzhou.github.io"],methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})),s.get("/",(async(t,e)=>{try{const t=await i.findAll();e.json(t)}catch(t){e.status(500).json({message:t.message})}})),s.post("/",(async(t,e)=>{try{const{title:a,summary:s,date:n,tags:r}=t.body,o=await i.create({title:a,summary:s,date:n,tags:r});e.status(201).json(o)}catch(t){e.status(400).json({message:t.message})}})),s.delete("/:id",(async(t,e)=>{try{const{id:a}=t.params;await i.delete(a)?e.status(204).end():e.status(404).json({message:"文章未找到"})}catch(t){e.status(500).json({message:t.message})}})),t.exports=s},346:(t,e,a)=>{const s=a(136);t.exports=class{static async findAll({page:t=1,pageSize:e=10}={}){const a=(t-1)*e,[i]=await s.query("SELECT a.*, GROUP_CONCAT(t.name) AS tag_names \n       FROM articles a \n       LEFT JOIN article_tags at ON a.id = at.article_id \n       LEFT JOIN tags t ON at.tag_id = t.id \n       GROUP BY a.id \n       ORDER BY a.date DESC \n       LIMIT ? OFFSET ?",[e,a]);return i.map((t=>({...t,tags:t.tag_names?t.tag_names.split(","):[]})))}static async create({title:t,summary:e,date:a,tags:i}){const n=await s.getConnection();try{await n.beginTransaction();const[s]=await n.query("INSERT INTO articles (title, summary, date) VALUES (?, ?, ?)",[t,e,a]),r=s.insertId;for(const t of i){let e,[a]=await n.query("SELECT id FROM tags WHERE name = ?",[t]);0===a.length?([a]=await n.query("INSERT INTO tags (name) VALUES (?)",[t]),e=a.insertId):e=a[0].id,await n.query("INSERT INTO article_tags (article_id, tag_id) VALUES (?, ?)",[r,e])}return await n.commit(),{id:r,title:t,summary:e,date:a,tags:i}}catch(t){throw await n.rollback(),t}finally{n.release()}}static async delete(t){const e=await s.getConnection();try{await e.beginTransaction(),await e.query("DELETE FROM article_tags WHERE article_id = ?",[t]);const[a]=await e.query("DELETE FROM articles WHERE id = ?",[t]);return await e.commit(),a.affectedRows>0}catch(t){throw await e.rollback(),t}finally{e.release()}}}},498:t=>{"use strict";t.exports=require("mysql2/promise")},577:t=>{"use strict";t.exports=require("cors")},818:t=>{"use strict";t.exports=require("dotenv")}},e={};function a(s){var i=e[s];if(void 0!==i)return i.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,a),n.exports}const s=a(252),i=s(),n=process.env.PORT||3e3,r=a(136),o=a(577);i.use(s.static("public")),i.use(s.json()),i.use(o({origin:["https://duwuzhou.github.io"],methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})),i.get("/",((t,e)=>{e.send("最基本的Node.js后端服务")}));const c=a(36),u=a(325);i.use("/users",c),i.use("/articles",u),i.use(((t,e,a,s)=>{console.error(t.stack),a.status(500).send("服务器内部错误")})),r.getConnection().then((()=>console.log("成功连接数据库"))).catch((t=>console.error("数据库连接失败:",t))),i.listen(n,(()=>{console.log(`服务器运行在:${n}`)}))})();