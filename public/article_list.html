<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章列表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .article-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .delete-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-left: 8px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .edit-btn {
            background-color: #007bff;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .edit-btn:hover {
            background-color: #0056b3;
        }
        .article-summary {
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .article-date {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .article-tags {
            color: #555;
            font-size: 0.9em;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }
        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .create-article-btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        .create-article-btn:hover {
            background-color: #218838;
        }
        .no-tags {
            color: #999;
            font-style: italic;
        }
        .article-content {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .toggle-content-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: underline;
            padding: 0;
            margin-top: 5px;
        }
        .toggle-content-btn:hover {
            color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>文章列表</h1>
    <div class="admin-section" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
        <h3>管理员功能</h3>
        <label for="adminPassword">管理员密码:</label>
        <input type="password" id="adminPassword" placeholder="请输入管理员密码" style="margin-right: 10px; padding: 5px;">
        <a href="create_article.html" class="create-article-btn">创建新文章</a>
    </div>
    <div id="articlesContainer"></div>

    <script>
        // 加载文章列表
        async function loadArticles() {
            try {
                const response = await fetch('/articles');
                const articles = await response.json();
                
                const container = document.getElementById('articlesContainer');
                container.innerHTML = articles.map(article => {
                    // 格式化日期显示
                    const dateObj = new Date(article.date);
                    const formattedDate = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                    
                    // 处理标签显示，如果没有标签则显示"无标签"
                    const tagsDisplay = article.tags && article.tags.length > 0 
                        ? `<div class="tag-container">${article.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
                        : '<span class="no-tags">无标签</span>';
                    
                    return `
                    <div class="article-item" data-id="${article.id}">
                        <div class="article-header">
                            <h3>${article.title}</h3>
                            <div>
                                <a href="edit_article.html?id=${article.id}" class="edit-btn">编辑</a>
                                <div class="delete-btn" onclick="deleteArticle(${article.id})">删除</div>
                            </div>
                        </div>
                        <p class="article-summary">摘要：${article.summary || '无摘要'}</p>
                        <button class="toggle-content-btn" onclick="toggleContent(${article.id})">查看全文</button>
                        <div class="article-content" id="content-${article.id}">
                            <p>${article.content || '无内容'}</p>
                        </div>
                        <div class="article-footer">
                            <p class="article-date">日期：${formattedDate}</p>
                            <div class="article-tags">标签：${tagsDisplay}</div>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('加载失败:', error);
                const container = document.getElementById('articlesContainer');
                container.innerHTML = '<p class="error-message">加载文章列表失败，请稍后重试</p>';
            }
        }

        // 切换文章内容显示
        function toggleContent(id) {
            const contentElement = document.getElementById(`content-${id}`);
            const buttonElement = event.target;
            
            if (contentElement.style.display === 'none' || contentElement.style.display === '') {
                contentElement.style.display = 'block';
                buttonElement.textContent = '收起全文';
            } else {
                contentElement.style.display = 'none';
                buttonElement.textContent = '查看全文';
            }
        }

        // 删除文章
        async function deleteArticle(id) {
            const adminPassword = document.getElementById('adminPassword').value;
            
            if (!adminPassword) {
                alert('请先输入管理员密码！');
                return;
            }
            
            if (confirm('确定要删除这篇文章吗？')) {
                try {
                    const response = await fetch(`/articles/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-password': adminPassword
                        }
                    });
                    
                    if (response.ok) {
                        alert('删除成功！');
                        loadArticles();
                    } else {
                        const errorData = await response.json();
                        alert(`删除失败: ${errorData.message}`);
                    }
                } catch (error) {
                    alert(`请求错误: ${error.message}`);
                }
            }
        }

        // 初始化加载
        loadArticles();
    </script>
</body>
</html>